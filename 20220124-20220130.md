# 问题

1. tcp、http协议的实现方式和配置参数
2. socket协议的实现方式和配置参数
3. kafka实现原理

注：题目都很大，每一题要完全吃透怕一周时间根本不够，所以讲一个总体和重要的。
因为过年事情比较多，也有身体原因，这个题目一直拖到20220213才开始草草回答。

# 回答

## 1. tcp、http协议的实现方式和配置参数

关于这个问题，我阅读了《HTTP权威指南》，回答这个问题主要是本书的第4章“连接管理”。

### HTTP连接（HTTPS）的分层结构

1. 应用层：HTTP协议
2. 安全层：TLS/SLL
3. 传输层：TCP协议
4. 网络层：IP协议
5. 数据链路层：网络特有的链路接口
6. 物理层：物理网络硬件

所以，HTTP通信由TCP/IP承载，TCP/IP是全球计算机及网络设备都在使用的一种常见的分组交换网络分层协议集，一旦连接建立，报文就不会丢失、受损、失序。因为TCP协议具有下面3个特点：
1. 无差错的数据传输
2. 按序传输
3. 未分段的数据流（可以在任意时刻以任意尺寸将数据发送出去）

### HTTP、TCP、IP协议实现过程

一个浏览器和服务器之间的HTTP事务（指一次HTTP请求和响应）具有如下步骤：
1. 浏览器解析http://wortin.com/index.html的主机名wortin.com
2. 浏览器查询主机名wortin.com对应的IP地址150.158.133.76
3. 浏览器获得端口号80
4. 浏览器发起到150.158.133.76:80的连接
5. 浏览器发送一条HTTP GET报文
6. 浏览器从服务器读取响应报文
7. 浏览器关闭连接

其中，第5步，HTTP会以流的形式将报文数据的内容通过一条打开的TCP连接按序传输。TCP收到数据流之后，会将数据流砍成小数据块，称为TCP段，并将段封装在IP分组中，通过因特网进行传输。

IP分组格式：
1. IP分组首部：包括源IP地址、目的IP地址、长度和其他标记等
2. TCP段首部：包括TCP源端口号、目的端口号、TCP控制标记、数据排序和完整性检查数字值等
3. TCP数据块：数据内容

其中，第4步到第7步，浏览器和服务器应用在编程时，通过调用TCP套接字接口（Socket API）实现。Socket API最初是由Unix操作系统开发的，现在几乎所有操作系统和语言中都有支持。
Socket API允许用户创建TCP的端点数据结构，将这些端点和远程服务器的TCP端点进行连接，并对数据流进行读写，隐藏了所有底层网络协议的握手、分段、重装等细节。

TCP连接常见Socket API:
+ 创建套接字：s = socket(<parameters>)
+ 绑定源IP和端口：bind(s, <local IP:port>)
+ 创建远程连接：connect(s, <remote IP:port>)
+ 接受连接：listen(s, ...)
+ 等待建立一条到本地端口的连接：s2 = accept(s)
+ 读取数据到缓冲区：n = read(s, buffer, n)
+ 从缓冲区写入数据：n = write(s, buffer, n)
+ 完全关闭TCP连接：close(s)
+ 只关闭TCP连接的输入或输出端：shutdown(s, <side>)

所以，第4步到第7步，从套接字的角度可以细分为如下步骤：
+ --- 服务器上的应用程序启动时
+ 服务端应用程序创建套接字 s = socket() 并绑定源IP和端口 bind(s, 150.158.133.76:80)
+ 服务端应用程序接受连接 listen(s, ...)
+ 服务端应用程序等待连接 s2 = accept(s)
+ --- 浏览器开始发送请求
+ 浏览器获取源IP和端口162.1.3.11:8080
+ 浏览器创建套接字 s = socket() 并绑定源IP和端口 bind(s, 162.1.3.11:8080)
+ 浏览器连接到服务器 connect(s, 150.158.133.76:80)
+ --- 服务器接收到来自浏览器的连接
+ 服务器通知应用程序有连接到来
+ 服务端应用程序开始读取请求 read
+ 服务端应用程序处理HTTP请求
+ 服务端应用程序回送HTTP响应 write
+ 服务端应用程序关闭连接 close
+ --- 服务器通知应用程序有连接到来时
+ 浏览器感知到连接成功
+ 浏览器发送HTTP请求 write
+ 浏览器等待HTTP响应 read
+ 浏览器处理响应
+ 浏览器关闭连接 close

### TCP连接的性能考虑

HTTP事务的时延来自：
1. DNS查询：如果最近没有某个URI访问，则需要通过DNS解析系统将URI中的主机名转化成一个IP。可能需要花费数10s
2. 建立TCP连接：客户端向服务端发送TCP连接请求，并等待请求接受应答。通常花费1-2s，但是如果事务超过数百个，耗时将快速叠加
3. 客户端发送请求报文、服务端处理报文、服务端回送报文

影响时延的因素取决于：
1. 硬件速度
2. 网络和服务器负载
3. 请求和响应报文的尺寸
4. 客户端和服务端的距离
5. TCP技术复杂性

对HTTP程序员产生影响的TCP时延因素：
1. TCP连接建立握手
2. TCP慢启动拥塞控制
3. 数据聚集的Nagle算法
4. 用于捎带确认的TCP延迟确认算法
5. TIME_WAIT时延和端口耗尽

### HTTP连接的处理

### 



